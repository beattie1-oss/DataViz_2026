)
###### Data Visualisation PS01 ######
# Ellen Beattie
#### Set up ####
# Remove objects
rm(list=ls())
# Detach all libraries
detachAllPackages <- function() {
basic.packages <- c("package:stats", "package:graphics", "package:grDevices", "package:utils", "package:datasets", "package:methods", "package:base")
package.list <- search()[ifelse(unlist(gregexpr("package:", search()))==1, TRUE, FALSE)]
package.list <- setdiff(package.list, basic.packages)
if (length(package.list)>0)  for (package in package.list) detach(package,  character.only=TRUE)
}
detachAllPackages()
# Load libraries
pkgTest <- function(pkg){
new.pkg <- pkg[!(pkg %in% installed.packages()[,  "Package"])]
if (length(new.pkg))
install.packages(new.pkg,  dependencies = TRUE)
sapply(pkg,  require,  character.only = TRUE)
}
# Load any necessary packages
lapply(c("tidyverse", "ggplot2", "readr", "readxl", "purrr", "ggridges", "ggdist", "xtable"),  pkgTest)
# Set working directory for current folder
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
getwd()
# Create Base theme
theme_ellen <- function(...) {
theme_minimal(base_size = 12, base_family = "serif") +
theme(
#Backgrounds
# Grid
panel.background = element_rect(fill = "white", colour = NA),
panel.border = element_rect(fill = NA, colour = "grey20"),
panel.grid = element_line(colour = "grey92"),
panel.grid.minor = element_line(size = rel(0.5)),
#Axis
axis.title = element_text(family = "serif", size = 12), #title font
axis.line.x = element_line(size = 0.4), #axis lines
axis.line.y = element_line(size = 0.4),
axis.text = element_text(colour = "black", size = 10), #axis text change
axis.ticks.x = element_line(colour = "black", size = 0.75),
#Legend
legend.title = element_text(family = 'serif', size = 12, colour = 'black'), #legend
legend.text =  element_text(family = 'serif', size = 10, colour = 'black'),# font change
legend.key.height = unit(1, "lines"),#spacing
legend.key.width = unit(1, "lines"),
legend.spacing.y = unit(1, "lines"),
legend.background = element_rect(
fill = "white",
colour = "grey30", #make box aound legend to align it
size = 0.5,
linetype = "solid")
)
}
#### Data Manipulation ####
# DM 1: Load Data #
NCSS <- read_csv("~/GitHub/DataViz_2026/datasets/NCSS_v1.csv")
NCSS <- NCSS %>%
select(CASEID, YEAR, GDREGION, NUMOFFMBR, TRAD6, TRAD12,INCOME) %>% #select certain vars
mutate(
GDREGION = as.factor(GDREGION), #turn character into factors
TRAD6 = as.factor(TRAD6),
TRAD12 = as.factor(TRAD12),
YEAR = as.integer(YEAR)
) %>%
rename( #rename for preferred names
'id' = 'CASEID',
'year' = 'YEAR',
'region' = 'GDREGION',
'n_members' = 'NUMOFFMBR',
'trad6' = 'TRAD6',
'trad12' = 'TRAD12',
'income' = 'INCOME'
)
# DM 2:  Filter by religious classifications
unique(NCSS$trad6) #to get exact spellings and see types
NCSS <- NCSS %>% #create
filter(trad6 %in% c('Chrétiennes', 'Juives', 'Musulmanes')) #filter out specific categories into new dataset
# DM 3: Compute Number of congregations, mean and median income by religion by year
n_congr_year <- NCSS %>% #trad 6 all religions
group_by(trad6, year) %>% #for each year within each
summarise(
total_congregations = n(),
mean_income = mean(income, na.rm = TRUE),
median_income = median(income, na.rm = TRUE),
.groups = "drop"
)
xtable(n_congr_year) #print table
# DM 4:  Create binary categorical variable avg_income
NCSS <- NCSS %>%
group_by(year) %>%
mutate(
year_avg_inc = mean(income, na.rm = TRUE), #find mean once each group
avg_income = case_when(
income >= year_avg_inc ~ 1L, #when income greater than mean, code as 1
income < year_avg_inc  ~ 0L #less than 0
)
) %>%
ungroup() #remove the groupings
#Print the average incomes of each year
aggregate(year_avg_inc ~ year, data = NCSS, FUN = mean)
#### 120 Date Visualisation ####
# DV 1: Bar Plot Av income Proportion by Trad12
summary(NCSS$income) # lots of NA's and skewed by some very large incomes (mean and quartiles )
#Create proportion stat for each religious classification for each year
avg_inc_trad12<- NCSS %>%
drop_na(income) %>% #remove na values
group_by(year, trad12) %>% #group by year then by specific category
summarise(
prop_abv_avg = mean(avg_income, na.rm = TRUE), #proportion as mean of avg income
prop_blw_avg = 1 - prop_abv_avg, #as range is 1 the remainder from 1 is the prop below
.group = "drop"
)
pdf("PS02_DV1.pdf")
ggplot(avg_inc_trad12, aes(x = trad12))+
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
dev.off()
# DV 2: Histogram #
summary(NCSS$n_members) #can see NA's
NCSS_groups <- NCSS %>%
filter(!is.na(n_members), year == "2022") #filter na and for the specific year
pdf("PS02_DV2.pdf")
ggplot(NCSS_groups,
aes(x = trad12, y = n_members, fill = trad6)) + #colour by trad 6
geom_col(position= position_dodge2(width= 0.5), alpha = 0.8) + #dodge2 for histogram look
facet_grid(. ~ trad6, scales = "free_x", space = "free_x") + #free x scales makes facets only have cateogories in it
scale_y_continuous(breaks = seq(0,25000,5000),limits = c(0,28000)) + #limit outliers out to see distributions
guides(fill = "none") + #looked cluttered and groups easily read
labs(y = "Number of Official Members",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(size = 10, angle = 35, hjust = 1),
panel.background = element_blank(),
panel.border = element_blank(), #remove box
panel.spacing = unit(0, "lines") ,#remove visual seperation
panel.grid.major.x = element_blank(),#keep only y so looks continuous
panel.grid.minor.x = element_blank(),
panel.spacing.x = unit(1, "lines"), #add space between facet subplots
strip.text = element_text(size = 10, face = "bold") #facet title font
) +
scale_fill_brewer(palette = "Set1") #colour
dev.off()
# DV3:  Yearly income distribution
summary(NCSS$region) #one NA region
summary(NCSS$income) #clearly large outlier
NCSS_region <- NCSS %>%
filter(!is.na(region), !is.na(income), year == "2022") %>% #filter out NA's and specify year
filter(income < quantile(income, 0.95)) #remove extreme values
pdf("PS02_DV3.pdf")
ggplot(NCSS_region, aes(x= income , y = region , fill= region)) +
geom_density_ridges(alpha = 0.7,
bandwidth = 15000,
linewidth = 0.4,
scale = 1.3) +
scale_x_continuous(limits = c(0, 1200000), expand = c(0,0))+
geom_vline(xintercept = 0, colour = "grey40", size = 0.3)+
guides(fill = "none")+
labs(y = "Region",  x = "Congregation Income", fill = "Region") +
theme_ridges() +
scale_fill_brewer(palette="Set3") +
theme(
text = element_text(family = "serif"),
axis.text.y = element_text(size = 12),
axis.text.x = element_text(size = 12, angle = 0, hjust = 1),
legend.position = "none"
)
dev.off()
# DV 4: Boxplot Members 2022 by classification and region
NCSS_22 <- NCSS %>%
filter(year == "2022", !is.na(region), !is.na(n_members))
# Check outliers
summary(NCSS_22$n_members)
pdf("PS02_DV4.pdf")
ggplot(NCSS_22, aes(x = trad6, y = n_members, fill = trad6)) +
geom_boxplot(outlier.shape = 1, outlier.size = 1, alpha = 0.75) +
facet_wrap(~ region, ncol = 4) +
coord_cartesian(ylim = c(0, 15000)) +
labs(y = "Number of Congregation Members",
x = "Religious Classification",
fill = "Religion") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 7), #angle to read without overlap
legend.position = "top",
strip.text = element_text(size = 8, face = "bold")
) +
scale_fill_brewer(palette="Set1")
dev.off()
ggplot(avg_inc_trad12, aes(x = trad12))+
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
ggplot(avg_inc_trad12, aes(x = trad12))+
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2, labeller = as_labeller(c("2009 \n mean", "2022 \n mean"))) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
ggplot(avg_inc_trad12, aes(x = trad12))+
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2,
labeller = as_labeller(c(A = "2009 \n mean", B = "2022 \n mean"))) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
ggplot(avg_inc_trad12, aes(x = trad12))+
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
ggplot(avg_inc_trad12, aes(x = trad12))+
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 0, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
ggplot(avg_inc_trad12, aes(x = trad12))+ #plotting classification on bottom
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+ #bar above
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+
coord_flip() +
facet_wrap(~ year, ncol = 2) +
scale_y_continuous(limits = c(-1, 1)) +
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2), guide = "none") +
geom_hline(yintercept = 0, color = "black") +
guides(fill = "none") +
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 0, hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
legend.position = "top"
)
###### Data Visualisation PS01 ######
# Ellen Beattie
#### Set up ####
# Remove objects
rm(list=ls())
# Detach all libraries
detachAllPackages <- function() {
basic.packages <- c("package:stats", "package:graphics", "package:grDevices", "package:utils", "package:datasets", "package:methods", "package:base")
package.list <- search()[ifelse(unlist(gregexpr("package:", search()))==1, TRUE, FALSE)]
package.list <- setdiff(package.list, basic.packages)
if (length(package.list)>0)  for (package in package.list) detach(package,  character.only=TRUE)
}
detachAllPackages()
# Load libraries
pkgTest <- function(pkg){
new.pkg <- pkg[!(pkg %in% installed.packages()[,  "Package"])]
if (length(new.pkg))
install.packages(new.pkg,  dependencies = TRUE)
sapply(pkg,  require,  character.only = TRUE)
}
# Load any necessary packages
lapply(c("tidyverse", "ggplot2", "readr", "readxl", "purrr", "ggridges", "ggdist", "xtable"),  pkgTest)
# Set working directory for current folder
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
getwd()
# Create Base theme
theme_ellen <- function(...) {
theme_minimal(base_size = 12, base_family = "serif") +
theme(
#Backgrounds
# Grid
panel.background = element_rect(fill = "white", colour = NA),
panel.border = element_rect(fill = NA, colour = "grey20"),
panel.grid = element_line(colour = "grey92"),
panel.grid.minor = element_line(size = rel(0.5)),
#Axis
axis.title = element_text(family = "serif", size = 12), #title font
axis.line.x = element_line(size = 0.4), #axis lines
axis.line.y = element_line(size = 0.4),
axis.text = element_text(colour = "black", size = 10), #axis text change
axis.ticks.x = element_line(colour = "black", size = 0.75),
#Legend
legend.title = element_text(family = 'serif', size = 12, colour = 'black'), #legend
legend.text =  element_text(family = 'serif', size = 10, colour = 'black'),# font change
legend.key.height = unit(1, "lines"),#spacing
legend.key.width = unit(1, "lines"),
legend.spacing.y = unit(1, "lines"),
legend.background = element_rect(
fill = "white",
colour = "grey30", #make box aound legend to align it
size = 0.5,
linetype = "solid")
)
}
#### Data Manipulation ####
# DM 1: Load Data #
NCSS <- read_csv("~/GitHub/DataViz_2026/datasets/NCSS_v1.csv")
NCSS <- NCSS %>%
select(CASEID, YEAR, GDREGION, NUMOFFMBR, TRAD6, TRAD12,INCOME) %>% #select certain vars
mutate(
GDREGION = as.factor(GDREGION), #turn character into factors
TRAD6 = as.factor(TRAD6),
TRAD12 = as.factor(TRAD12),
YEAR = as.integer(YEAR)
) %>%
rename( #rename for preferred names
'id' = 'CASEID',
'year' = 'YEAR',
'region' = 'GDREGION',
'n_members' = 'NUMOFFMBR',
'trad6' = 'TRAD6',
'trad12' = 'TRAD12',
'income' = 'INCOME'
)
# DM 2:  Filter by religious classifications
unique(NCSS$trad6) #to get exact spellings and see types
NCSS <- NCSS %>% #create
filter(trad6 %in% c('Chrétiennes', 'Juives', 'Musulmanes')) #filter out specific categories into new dataset
# DM 3: Compute Number of congregations, mean and median income by religion by year
n_congr_year <- NCSS %>% #trad 6 all religions
group_by(trad6, year) %>% #for each year within each
summarise(
total_congregations = n(),
mean_income = mean(income, na.rm = TRUE),
median_income = median(income, na.rm = TRUE),
.groups = "drop"
)
xtable(n_congr_year) #print table
# DM 4:  Create binary categorical variable avg_income
NCSS <- NCSS %>%
group_by(year) %>%
mutate(
year_avg_inc = mean(income, na.rm = TRUE), #find mean once each group
avg_income = case_when(
income >= year_avg_inc ~ 1L, #when income greater than mean, code as 1
income < year_avg_inc  ~ 0L #less than 0
)
) %>%
ungroup() #remove the groupings
#Print the average incomes of each year
aggregate(year_avg_inc ~ year, data = NCSS, FUN = mean)
#### 120 Date Visualisation ####
# DV 1: Bar Plot Av income Proportion by Trad12
summary(NCSS$income) # lots of NA's and skewed by some very large incomes (mean and quartiles )
#Create proportion stat for each religious classification for each year
avg_inc_trad12<- NCSS %>%
drop_na(income) %>% #remove na values
group_by(year, trad12) %>% #group by year then by specific category
summarise(
prop_abv_avg = mean(avg_income, na.rm = TRUE), #proportion as mean of avg income
prop_blw_avg = 1 - prop_abv_avg, #as range is 1 the remainder from 1 is the prop below
.group = "drop"
)
pdf("PS02_DV1.pdf")
ggplot(avg_inc_trad12, aes(x = trad12))+ #plotting classification on bottom
geom_col(aes(y = prop_abv_avg, fill = trad12, alpha = "above"), width = 0.75)+ #bar above
geom_col(aes(y = -prop_blw_avg, fill = trad12, alpha = "below"), width = 0.75)+ # below axis
coord_flip() + #reverse x and y facts from above to see time progression
facet_wrap(~ year, ncol = 2) + #group by year
scale_y_continuous(limits = c(-1, 1)) + #clear limits
scale_alpha_manual(values = c("above" = 0.9, "below" = 0.2),
guide = "none") + #transparency different for above and below
geom_hline(yintercept = 0, color = "black") + #strengthen the line of the "average"
guides(fill = "none") + #remove excess legend
labs(y = "\n Proportion of Congregations Above / Below the Average Income",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(hjust = 1, size = 10),
axis.text.y = element_text(size = 11),
)
dev.off()
# DV 2: Histogram # 161
summary(NCSS$n_members) #can see NA's
NCSS_groups <- NCSS %>%
filter(!is.na(n_members), year == "2022") #filter na and for the specific year
pdf("PS02_DV2.pdf")
ggplot(NCSS_groups,
aes(x = trad12, y = n_members, fill = trad6)) + #colour by trad 6
geom_col(position= position_dodge2(width= 0.5), alpha = 0.8) + #dodge2 for histogram look
facet_grid(. ~ trad6, scales = "free_x", space = "free_x") + #free x scales makes facets only have cateogories in it
scale_y_continuous(breaks = seq(0,25000,5000),limits = c(0,28000)) + #limit outliers out to see distributions
guides(fill = "none") + #looked cluttered and groups easily read
labs(y = "Number of Official Members",
x = "Religious Classification") +
theme_ellen() +
theme(
axis.text.x = element_text(size = 10, angle = 35, hjust = 1), #tilt text for legibility
panel.background = element_blank(),
panel.border = element_blank(), #remove box
panel.spacing = unit(0, "lines") ,#remove visual seperation
panel.grid.major.x = element_blank(),#keep only y so looks continuous
panel.grid.minor.x = element_blank(),
panel.spacing.x = unit(1, "lines"), #add space between facet subplots
strip.text = element_text(size = 10, face = "bold") #facet title font
) +
scale_fill_brewer(palette = "Set1") #colour
dev.off()
# DV3:  Yearly income distribution
summary(NCSS$region) #one NA region
summary(NCSS$income) #clearly large outlier
NCSS_region <- NCSS %>%
filter(!is.na(region), !is.na(income), year == "2022") %>% #filter out NA's and specify year
filter(income < quantile(income, 0.95)) #remove extreme values
pdf("PS02_DV3.pdf")
ggplot(NCSS_region, aes(x= income , y = region , fill= region)) +
geom_density_ridges(alpha = 0.7, #transparency
bandwidth = 15000, #smoothness of the plot
linewidth = 0.4, #thick line
scale = 1.3) + #scale height of factors
scale_x_continuous(limits = c(0, 1200000), expand = c(0,0))+ #limit x axis for visbilty
geom_vline(xintercept = 0, colour = "grey40", size = 0.3)+ #strengthen y-axis
guides(fill = "none")+ #remove redundant legend
labs(y = "Region",  x = "Congregation Income", fill = "Region") +
theme_ridges() + #try theme meant specifically for ridges
scale_fill_brewer(palette="Set3") +
theme(
text = element_text(family = "serif"), #change back font
axis.text.y = element_text(size = 12),
axis.text.x = element_text(size = 12, angle = 0, hjust = 1),
legend.position = "none"
)
dev.off()
# DV 4: Boxplot Members 2022 by classification and region
NCSS_22 <- NCSS %>%
filter(year == "2022", !is.na(region), !is.na(n_members)) #2022 only and rmv missing
# Check outliers
summary(NCSS_22$n_members) #check outliers may distort
pdf("PS02_DV4.pdf")
ggplot(NCSS_22, aes(x = trad6, y = n_members, fill = trad6)) + #use filtered set,
geom_boxplot(outlier.shape = 1, outlier.size = 1, alpha = 0.75) + #specify outlier shape/size
facet_wrap(~ region, ncol = 4) + #4 columns (7 doesn't divide nicely)
coord_cartesian(ylim = c(0, 15000)) + #limit the scale to increase box readability
labs(y = "Number of Congregation Members",
x = "Religious Classification",
fill = "Religion") +
theme_ellen() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 7), #angle to read without overlap
legend.position = "top", #at top to give as much width as possibe
strip.text = element_text(size = 8, face = "bold")
) +
scale_fill_brewer(palette="Set1") #colour scale
dev.off()
